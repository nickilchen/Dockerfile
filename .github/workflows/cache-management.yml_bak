name: ðŸš€ Build Performance and Cache Management

on:
  # æ‰‹åŠ¨è§¦å‘ç¼“å­˜ç®¡ç†
  workflow_dispatch:
    inputs:
      action:
        description: 'Cache management action'
        required: true
        default: 'warm-cache'
        type: choice
        options:
          - warm-cache
          - clear-cache
          - analyze-cache
          - benchmark-build
      platform:
        description: 'Target platform for cache warming'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

  # å®šæ—¶ç¼“å­˜é¢„çƒ­ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨ï¼‰
  schedule:
    - cron: '0 2 * * 0'

  # ä¸»åˆ†æ”¯æŽ¨é€æ—¶è¿›è¡Œç¼“å­˜åˆ†æž
  push:
    branches:
      - main
    paths:
      - 'gdal/Dockerfile'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gdal-multi-arch
  GDAL_VERSION: "3.7.1"
  JAVA_VERSION: "8"

jobs:
  # ç¼“å­˜é¢„çƒ­
  warm-cache:
    name: ðŸ”¥ Warm Build Cache
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.action == 'warm-cache')
    
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: ðŸ”¥ Warm cache for ${{ matrix.platform }}
        uses: docker/build-push-action@v5
        with:
          context: ./gdal
          file: ./gdal/Dockerfile
          platforms: ${{ matrix.platform }}
          push: false
          cache-from: type=gha,scope=cache-warm-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=cache-warm-${{ matrix.platform }}
          build-args: |
            GDAL_VERSION=${{ env.GDAL_VERSION }}
            BUILDKIT_INLINE_CACHE=1

      - name: ðŸ“Š Cache warming summary
        run: |
          echo "âœ… Cache warmed for platform: ${{ matrix.platform }}"
          echo "ðŸ”‘ Cache scope: cache-warm-${{ matrix.platform }}"

  # ç¼“å­˜æ¸…ç†
  clear-cache:
    name: ðŸ§¹ Clear Build Cache
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'clear-cache'
    permissions:
      actions: write
      
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§¹ Clear GitHub Actions cache
        run: |
          echo "ðŸ§¹ Clearing GitHub Actions cache..."
          
          # èŽ·å–æ‰€æœ‰ç¼“å­˜
          CACHES=$(gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '.actions_caches[].key')
          
          if [[ -z "$CACHES" ]]; then
            echo "ðŸ“‹ No caches found to clear"
            exit 0
          fi
          
          echo "ðŸ“‹ Found caches to clear:"
          echo "$CACHES"
          
          # åˆ é™¤æ‰€æœ‰ç¼“å­˜
          echo "$CACHES" | while read -r cache_key; do
            if [[ -n "$cache_key" ]]; then
              echo "ðŸ—‘ï¸ Deleting cache: $cache_key"
              gh api repos/${{ github.repository }}/actions/caches \
                --method DELETE \
                --field key="$cache_key" || echo "âš ï¸ Failed to delete $cache_key"
            fi
          done
          
          echo "âœ… Cache clearing completed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¼“å­˜åˆ†æž
  analyze-cache:
    name: ðŸ“Š Analyze Cache Performance
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'analyze-cache' || github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“Š Analyze cache usage
        run: |
          echo "ðŸ“Š Analyzing cache performance..."
          
          # èŽ·å–ç¼“å­˜ä¿¡æ¯
          gh api repos/${{ github.repository }}/actions/caches --paginate > cache_info.json
          
          echo "## ðŸ“Š Cache Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ€»ç¼“å­˜æ•°é‡å’Œå¤§å°
          TOTAL_CACHES=$(jq '.actions_caches | length' cache_info.json)
          TOTAL_SIZE=$(jq '[.actions_caches[].size_in_bytes] | add' cache_info.json)
          TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
          
          echo "### ðŸ“ˆ ç¼“å­˜ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ç¼“å­˜æ•°é‡**: $TOTAL_CACHES" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»å¤§å°**: ${TOTAL_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŒ‰ç±»åž‹åˆ†ç»„çš„ç¼“å­˜
          echo "### ðŸ·ï¸ ç¼“å­˜ç±»åž‹åˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
          jq -r '.actions_caches[] | .key' cache_info.json | sed 's/-.*$//' | sort | uniq -c | \
          while read count prefix; do
            echo "- **${prefix}**: ${count} ä¸ªç¼“å­˜" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æœ€è¿‘ä½¿ç”¨çš„ç¼“å­˜
          echo "### ðŸ•’ æœ€è¿‘ä½¿ç”¨çš„ç¼“å­˜" >> $GITHUB_STEP_SUMMARY
          jq -r '.actions_caches[] | select(.last_accessed_at != null) | "\(.key) - \(.last_accessed_at)"' cache_info.json | \
          head -10 | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done
          
          # ç¼“å­˜ä¼˜åŒ–å»ºè®®
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ ä¼˜åŒ–å»ºè®®" >> $GITHUB_STEP_SUMMARY
          
          if [[ $TOTAL_CACHES -gt 50 ]]; then
            echo "- âš ï¸ ç¼“å­˜æ•°é‡è¾ƒå¤šï¼Œå»ºè®®å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„ç¼“å­˜" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ $TOTAL_SIZE_MB -gt 2000 ]]; then
            echo "- âš ï¸ ç¼“å­˜å¤§å°è¾ƒå¤§ï¼Œå»ºè®®ä¼˜åŒ–Dockerfileä»¥å‡å°‘å±‚æ•°" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- âœ… å®šæœŸè¿è¡Œç¼“å­˜é¢„çƒ­ä»¥æé«˜æž„å»ºé€Ÿåº¦" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ç›‘æŽ§ç¼“å­˜å‘½ä¸­çŽ‡å’Œæž„å»ºæ—¶é—´" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æž„å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark-build:
    name: âš¡ Build Performance Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'benchmark-build'
    
    strategy:
      matrix:
        cache-mode: [no-cache, with-cache]
        platform: [linux/amd64, linux/arm64]
        
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: âš¡ Benchmark build performance
        id: benchmark
        run: |
          PLATFORM="${{ matrix.platform }}"
          CACHE_MODE="${{ matrix.cache-mode }}"
          
          echo "ðŸ Starting benchmark for $PLATFORM with $CACHE_MODE"
          
          # æž„å»ºå‚æ•°
          BUILD_ARGS="--platform=$PLATFORM --file=./gdal/Dockerfile ./gdal"
          
          if [[ "$CACHE_MODE" == "with-cache" ]]; then
            BUILD_ARGS="$BUILD_ARGS --cache-from=type=gha,scope=benchmark-$PLATFORM"
            BUILD_ARGS="$BUILD_ARGS --cache-to=type=gha,mode=max,scope=benchmark-$PLATFORM"
          else
            BUILD_ARGS="$BUILD_ARGS --no-cache"
          fi
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # æ‰§è¡Œæž„å»º
          echo "ðŸ—ï¸ Building with: $BUILD_ARGS"
          docker buildx build $BUILD_ARGS --build-arg GDAL_VERSION=${{ env.GDAL_VERSION }}
          
          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "cache-mode=$CACHE_MODE" >> $GITHUB_OUTPUT
          
          echo "âœ… Build completed in ${DURATION} seconds"

      - name: ðŸ“Š Record benchmark results
        run: |
          DURATION="${{ steps.benchmark.outputs.duration }}"
          PLATFORM="${{ steps.benchmark.outputs.platform }}"
          CACHE_MODE="${{ steps.benchmark.outputs.cache-mode }}"
          
          # åˆ›å»ºç»“æžœæ–‡ä»¶
          echo "platform,cache_mode,duration_seconds,timestamp" > benchmark-result.csv
          echo "$PLATFORM,$CACHE_MODE,$DURATION,$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> benchmark-result.csv
          
          # æ˜¾ç¤ºç»“æžœ
          echo "## âš¡ æž„å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | ç¼“å­˜æ¨¡å¼ | æž„å»ºæ—¶é—´ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| $PLATFORM | $CACHE_MODE | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY

  # æ€§èƒ½ç›‘æŽ§æŠ¥å‘Š
  performance-report:
    name: ðŸ“ˆ Performance Monitoring Report
    runs-on: ubuntu-latest
    needs: [benchmark-build]
    if: always() && github.event_name == 'workflow_dispatch' && inputs.action == 'benchmark-build'
    
    steps:
      - name: ðŸ“ˆ Generate performance report
        run: |
          echo "## ðŸ“ˆ æž„å»ºæ€§èƒ½ç›‘æŽ§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ æ€§èƒ½ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "- **AMD64æž„å»ºæ—¶é—´** < 15åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- **ARM64æž„å»ºæ—¶é—´** < 20åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜å‘½ä¸­çŽ‡** > 80%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ä¼˜åŒ–å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸš€ **ä½¿ç”¨å¤šé˜¶æ®µæž„å»º**å‡å°‘æœ€ç»ˆé•œåƒå¤§å°" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“¦ **ä¼˜åŒ–ä¾èµ–å®‰è£…é¡ºåº**æé«˜ç¼“å­˜å‘½ä¸­çŽ‡" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ”„ **å®šæœŸé¢„çƒ­ç¼“å­˜**ä¿æŒæž„å»ºé€Ÿåº¦" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ§¹ **æ¸…ç†æ— ç”¨ç¼“å­˜**èŠ‚çœå­˜å‚¨ç©ºé—´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š åŽ†å²æ€§èƒ½è¶‹åŠ¿" >> $GITHUB_STEP_SUMMARY
          echo "å¯ä»¥é€šè¿‡GitHub Actionsçš„æž„å»ºåŽ†å²æŸ¥çœ‹æ€§èƒ½è¶‹åŠ¿ã€‚" >> $GITHUB_STEP_SUMMARY