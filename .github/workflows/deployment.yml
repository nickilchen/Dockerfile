name: ğŸŒ Multi-Environment Deployment

on:
  # æ‰‹åŠ¨è§¦å‘å¤šç¯å¢ƒéƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy'
        required: false
        default: 'latest'
        type: string
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean

  # è‡ªåŠ¨éƒ¨ç½²è§„åˆ™
  push:
    branches:
      - main      # éƒ¨ç½²åˆ°staging
      - develop   # éƒ¨ç½²åˆ°development
    paths:
      - 'gdal/**'

  # å‘å¸ƒæ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gdal-multi-arch
  GDAL_VERSION: "3.7.1"

jobs:
  # éƒ¨ç½²é…ç½®åˆ†æ
  deployment-config:
    name: ğŸ“‹ Deployment Configuration
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      image-tag: ${{ steps.config.outputs.image-tag }}
      deploy-approved: ${{ steps.config.outputs.deploy-approved }}
      registry-url: ${{ steps.config.outputs.registry-url }}
      
    steps:
      - name: ğŸ” Determine deployment configuration
        id: config
        run: |
          # ç¡®å®šç›®æ ‡ç¯å¢ƒ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ inputs.environment }}"
            IMAGE_TAG="${{ inputs.image_tag }}"
            FORCE_DEPLOY="${{ inputs.force_deploy }}"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            ENVIRONMENT="production"
            IMAGE_TAG="${{ github.event.release.tag_name }}"
            FORCE_DEPLOY="false"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENVIRONMENT="staging"
            IMAGE_TAG="latest"
            FORCE_DEPLOY="false"
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            ENVIRONMENT="development"
            IMAGE_TAG="dev"
            FORCE_DEPLOY="false"
          else
            echo "âŒ Unsupported branch for automatic deployment: ${{ github.ref_name }}"
            exit 1
          fi
          
          # ç¡®å®šæ˜¯å¦æ‰¹å‡†éƒ¨ç½²
          DEPLOY_APPROVED="true"
          if [[ "$ENVIRONMENT" == "production" && "$FORCE_DEPLOY" != "true" ]]; then
            # ç”Ÿäº§ç¯å¢ƒéœ€è¦é¢å¤–éªŒè¯
            if [[ "${{ github.event_name }}" != "release" ]]; then
              DEPLOY_APPROVED="false"
              echo "âš ï¸ Production deployment requires release event or force flag"
            fi
          fi
          
          # è®¾ç½®æ³¨å†Œè¡¨URL
          REGISTRY_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          
          # è¾“å‡ºé…ç½®
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "deploy-approved=$DEPLOY_APPROVED" >> $GITHUB_OUTPUT
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºé…ç½®
          echo "ğŸŒ Deployment Configuration:"
          echo "  ğŸ¯ Environment: $ENVIRONMENT"
          echo "  ğŸ·ï¸ Image Tag: $IMAGE_TAG"
          echo "  ğŸ“¤ Registry URL: $REGISTRY_URL"
          echo "  âœ… Deploy Approved: $DEPLOY_APPROVED"

  # å¼€å‘ç¯å¢ƒéƒ¨ç½²
  deploy-development:
    name: ğŸ§ª Deploy to Development
    runs-on: ubuntu-latest
    needs: deployment-config
    if: needs.deployment-config.outputs.environment == 'development' && needs.deployment-config.outputs.deploy-approved == 'true'
    environment:
      name: development
      url: https://dev-gdal.example.com
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure development credentials
        run: |
          echo "ğŸ”§ Configuring development environment..."
          # è¿™é‡Œå¯ä»¥è®¾ç½®å¼€å‘ç¯å¢ƒç‰¹å®šçš„é…ç½®
          echo "DEV_NAMESPACE=gdal-dev" >> $GITHUB_ENV
          echo "DEV_REPLICAS=1" >> $GITHUB_ENV

      - name: ğŸš€ Deploy to development
        run: |
          echo "ğŸš€ Deploying to development environment..."
          echo "ğŸ“¦ Image: ${{ needs.deployment-config.outputs.registry-url }}"
          
          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          echo "kubectl set image deployment/gdal-app gdal=${{ needs.deployment-config.outputs.registry-url }} -n $DEV_NAMESPACE"
          echo "kubectl rollout status deployment/gdal-app -n $DEV_NAMESPACE"
          
          # å®é™…éƒ¨ç½²æ—¶ï¼Œè¿™é‡Œä¼šæœ‰çœŸå®çš„kubectlå‘½ä»¤æˆ–å…¶ä»–éƒ¨ç½²å·¥å…·
          echo "âœ… Development deployment completed"

      - name: ğŸ§ª Run development tests
        run: |
          echo "ğŸ§ª Running development environment tests..."
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ” Health check..."
          # curl -f https://dev-gdal.example.com/health || exit 1
          
          # åŠŸèƒ½æµ‹è¯•
          echo "ğŸ”¬ Functional tests..."
          # è¿™é‡Œå¯ä»¥è¿è¡Œé›†æˆæµ‹è¯•
          
          echo "âœ… Development tests passed"

      - name: ğŸ“Š Development deployment summary
        run: |
          echo "## ğŸ§ª Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ¯ Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ Image**: \`${{ needs.deployment-config.outputs.registry-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ URL**: https://dev-gdal.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- **â° Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **âœ… Status**: Success" >> $GITHUB_STEP_SUMMARY

  # é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: deployment-config
    if: needs.deployment-config.outputs.environment == 'staging' && needs.deployment-config.outputs.deploy-approved == 'true'
    environment:
      name: staging
      url: https://staging-gdal.example.com
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure staging credentials
        run: |
          echo "ğŸ”§ Configuring staging environment..."
          echo "STAGING_NAMESPACE=gdal-staging" >> $GITHUB_ENV
          echo "STAGING_REPLICAS=2" >> $GITHUB_ENV

      - name: ğŸ” Pre-deployment validation
        run: |
          echo "ğŸ” Validating image before staging deployment..."
          
          # éªŒè¯é•œåƒå­˜åœ¨
          docker manifest inspect ${{ needs.deployment-config.outputs.registry-url }}
          
          # å®‰å…¨æ‰«æ
          echo "ğŸ”’ Security scan..."
          # trivy image ${{ needs.deployment-config.outputs.registry-url }}
          
          echo "âœ… Pre-deployment validation passed"

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "ğŸ“¦ Image: ${{ needs.deployment-config.outputs.registry-url }}"
          
          # è“ç»¿éƒ¨ç½²ç­–ç•¥
          echo "ğŸ”µ Blue-Green deployment strategy"
          echo "kubectl set image deployment/gdal-app gdal=${{ needs.deployment-config.outputs.registry-url }} -n $STAGING_NAMESPACE"
          echo "kubectl rollout status deployment/gdal-app -n $STAGING_NAMESPACE --timeout=600s"
          
          echo "âœ… Staging deployment completed"

      - name: ğŸ§ª Run staging tests
        run: |
          echo "ğŸ§ª Running staging environment tests..."
          
          # è´Ÿè½½æµ‹è¯•
          echo "âš¡ Load testing..."
          # k6 run staging-load-test.js
          
          # é›†æˆæµ‹è¯•
          echo "ğŸ”— Integration testing..."
          # pytest tests/integration/
          
          # æ€§èƒ½æµ‹è¯•
          echo "ğŸ“Š Performance testing..."
          # artillery run staging-performance-test.yml
          
          echo "âœ… Staging tests passed"

      - name: ğŸ“Š Staging deployment summary
        run: |
          echo "## ğŸ­ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ¯ Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ Image**: \`${{ needs.deployment-config.outputs.registry-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ URL**: https://staging-gdal.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- **â° Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **âœ… Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”„ Strategy**: Blue-Green Deployment" >> $GITHUB_STEP_SUMMARY

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦äººå·¥å®¡æ‰¹ï¼‰
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: deployment-config
    if: needs.deployment-config.outputs.environment == 'production' && needs.deployment-config.outputs.deploy-approved == 'true'
    environment:
      name: production
      url: https://gdal.example.com
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure production credentials
        run: |
          echo "ğŸ”§ Configuring production environment..."
          echo "PROD_NAMESPACE=gdal-prod" >> $GITHUB_ENV
          echo "PROD_REPLICAS=3" >> $GITHUB_ENV

      - name: ğŸ” Production readiness check
        run: |
          echo "ğŸ” Production readiness validation..."
          
          # éªŒè¯é•œåƒç­¾å
          echo "ğŸ” Verifying image signature..."
          # cosign verify ${{ needs.deployment-config.outputs.registry-url }}
          
          # æœ€ç»ˆå®‰å…¨æ‰«æ
          echo "ğŸ”’ Final security scan..."
          # trivy image --severity HIGH,CRITICAL ${{ needs.deployment-config.outputs.registry-url }}
          
          # éªŒè¯é…ç½®
          echo "ğŸ“‹ Configuration validation..."
          # éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
          
          echo "âœ… Production readiness check passed"

      - name: ğŸ“‹ Create deployment backup
        run: |
          echo "ğŸ’¾ Creating deployment backup..."
          
          # å¤‡ä»½å½“å‰é…ç½®
          echo "kubectl get deployment gdal-app -n $PROD_NAMESPACE -o yaml > backup-$(date +%Y%m%d-%H%M%S).yaml"
          
          # è®°å½•å½“å‰é•œåƒç‰ˆæœ¬
          CURRENT_IMAGE=$(kubectl get deployment gdal-app -n $PROD_NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "none")
          echo "ğŸ“ Current image: $CURRENT_IMAGE"
          echo "current-image=$CURRENT_IMAGE" >> $GITHUB_ENV
          
          echo "âœ… Backup created"

      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ Deploying to production environment..."
          echo "ğŸ“¦ Image: ${{ needs.deployment-config.outputs.registry-url }}"
          
          # æ»šåŠ¨æ›´æ–°ç­–ç•¥
          echo "ğŸ”„ Rolling update deployment strategy"
          echo "kubectl set image deployment/gdal-app gdal=${{ needs.deployment-config.outputs.registry-url }} -n $PROD_NAMESPACE"
          echo "kubectl rollout status deployment/gdal-app -n $PROD_NAMESPACE --timeout=900s"
          
          # éªŒè¯éƒ¨ç½²
          echo "ğŸ” Verifying deployment..."
          echo "kubectl get pods -n $PROD_NAMESPACE -l app=gdal-app"
          
          echo "âœ… Production deployment completed"

      - name: ğŸ§ª Run production smoke tests
        run: |
          echo "ğŸ§ª Running production smoke tests..."
          
          # å¥åº·æ£€æŸ¥
          echo "â¤ï¸ Health check..."
          # curl -f https://gdal.example.com/health
          
          # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
          echo "ğŸ”¬ Basic functionality test..."
          # æµ‹è¯•æ ¸å¿ƒGDALåŠŸèƒ½
          
          # ç›‘æ§å‘Šè­¦æ£€æŸ¥
          echo "ğŸ“Š Monitoring check..."
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å‘Šè­¦
          
          echo "âœ… Production smoke tests passed"

      - name: ğŸ“Š Production deployment summary
        run: |
          echo "## ğŸ­ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ¯ Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ New Image**: \`${{ needs.deployment-config.outputs.registry-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ Previous Image**: \`${{ env.current-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ URL**: https://gdal.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- **â° Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **âœ… Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”„ Strategy**: Rolling Update" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ‘¥ Replicas**: ${{ env.PROD_REPLICAS }}" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åç›‘æ§
  post-deployment-monitoring:
    name: ğŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deployment-config, deploy-development, deploy-staging, deploy-production]
    if: always() && (needs.deploy-development.result == 'success' || needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
      - name: ğŸ“Š Setup monitoring
        run: |
          ENVIRONMENT="${{ needs.deployment-config.outputs.environment }}"
          echo "ğŸ“Š Setting up post-deployment monitoring for $ENVIRONMENT..."
          
          # è®¾ç½®ç›‘æ§å‘Šè­¦
          echo "ğŸš¨ Configuring alerts..."
          
          # å¯åŠ¨ç›‘æ§ä»»åŠ¡
          echo "ğŸ‘€ Starting monitoring tasks..."
          
          # åˆ›å»ºç›‘æ§æŠ¥å‘Š
          echo "## ğŸ“Š Post-Deployment Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Environment: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“ˆ ç›‘æ§æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "- **CPUä½¿ç”¨ç‡**: < 70%" >> $GITHUB_STEP_SUMMARY
          echo "- **å†…å­˜ä½¿ç”¨ç‡**: < 80%" >> $GITHUB_STEP_SUMMARY
          echo "- **å“åº”æ—¶é—´**: < 2ç§’" >> $GITHUB_STEP_SUMMARY
          echo "- **é”™è¯¯ç‡**: < 1%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸš¨ å‘Šè­¦é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- CPUä½¿ç”¨ç‡è¶…è¿‡80%æ—¶å‘Šè­¦" >> $GITHUB_STEP_SUMMARY
          echo "- å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%æ—¶å‘Šè­¦" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨æ— å“åº”æ—¶ç«‹å³å‘Šè­¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ç›‘æ§å°†æŒç»­24å°æ—¶ï¼Œå¦‚æœ‰å¼‚å¸¸å°†è‡ªåŠ¨é€šçŸ¥ç›¸å…³å›¢é˜Ÿã€‚" >> $GITHUB_STEP_SUMMARY

  # å›æ»šæµç¨‹
  rollback-deployment:
    name: ğŸ”„ Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && (github.event_name == 'workflow_dispatch' || github.event_name == 'release')
    needs: [deployment-config, deploy-development, deploy-staging, deploy-production]
    environment:
      name: ${{ needs.deployment-config.outputs.environment }}
      
    steps:
      - name: ğŸ”„ Execute rollback
        run: |
          ENVIRONMENT="${{ needs.deployment-config.outputs.environment }}"
          echo "ğŸ”„ Executing rollback for $ENVIRONMENT environment..."
          
          # æ‰§è¡Œå›æ»š
          echo "kubectl rollout undo deployment/gdal-app -n gdal-$ENVIRONMENT"
          echo "kubectl rollout status deployment/gdal-app -n gdal-$ENVIRONMENT"
          
          # éªŒè¯å›æ»š
          echo "ğŸ” Verifying rollback..."
          
          echo "âœ… Rollback completed successfully"
          
          # é€šçŸ¥
          echo "ğŸ“§ Notifying team about rollback..."