name: ðŸ³ Build and Push GDAL OpenJDK Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push to registry'
        required: false
        default: 'true'
        type: boolean
      platforms:
        description: 'Target platforms'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      tag_suffix:
        description: 'Tag suffix (e.g., -dev, -beta)'
        required: false
        default: ''
        type: string

  # æŽ¨é€è§¦å‘ï¼ˆåˆ†æ”¯å’Œæ ‡ç­¾ï¼‰
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
      - 'gdal-*'
    paths:
      - 'gdal/Dockerfile_openjdk'
      - 'gdal/build-openjdk.sh'
      - '.github/workflows/docker-build-openjdk.yml'

  # Pull Requestæ—¶è§¦å‘ï¼ˆä»…æž„å»ºï¼Œä¸æŽ¨é€ï¼‰
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'gdal/Dockerfile_openjdk'
      - 'gdal/build-openjdk.sh'
      - '.github/workflows/docker-build-openjdk.yml'

env:
  # é•œåƒä»“åº“é…ç½®
  REGISTRY: ghcr.io
  ALI_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_NAME: ${{ github.repository }}/gdal-openjdk
  ALI_IMAGE_NAME: nickilchen/gdal-openjdk
  
  # GDALé…ç½®
  GDAL_VERSION: "3.7.1"
  JAVA_VERSION: "8u342"

jobs:
  # æž„å»ºé…ç½®åˆ†æž
  build-config:
    name: ðŸ“‹ Build Configuration
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.config.outputs.registry }}
      image-name: ${{ steps.config.outputs.image-name }}
      platforms: ${{ steps.config.outputs.platforms }}
      push-enabled: ${{ steps.config.outputs.push-enabled }}
      cache-key: ${{ steps.config.outputs.cache-key }}
      tags: ${{ steps.config.outputs.tags }}
      
    steps:
      - name: ðŸ” Analyze build configuration
        id: config
        run: |
          # ç¡®å®šæ˜¯å¦æŽ¨é€
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PUSH_ENABLED="false"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PUSH_ENABLED="${{ inputs.push_to_registry }}"
          else
            PUSH_ENABLED="true"
          fi
          
          # ç¡®å®šå¹³å°
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.platforms }}" ]]; then
            PLATFORMS="${{ inputs.platforms }}"
          else
            PLATFORMS="linux/amd64,linux/arm64"
          fi
          
          # ç¡®å®šæ ‡ç­¾
          TAGS=""
          ALI_TAGS=""
          BRANCH_NAME="${{ github.ref_name }}"
          TAG_SUFFIX="${{ inputs.tag_suffix || '' }}"
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # æ ‡ç­¾æŽ¨é€
            if [[ "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VERSION="${{ github.ref_name }}"
              TAGS="${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:${VERSION#v}${TAG_SUFFIX}"
              TAGS="${TAGS},${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:latest${TAG_SUFFIX}"
              # é˜¿é‡Œäº‘æ ‡ç­¾ï¼ˆä½¿ç”¨GDALç‰ˆæœ¬ï¼‰
              ALI_TAGS="${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:${{ env.GDAL_VERSION }}${TAG_SUFFIX}"
              ALI_TAGS="${ALI_TAGS},${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:latest${TAG_SUFFIX}"
            else
              TAGS="${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:${{ github.ref_name }}${TAG_SUFFIX}"
              ALI_TAGS="${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:${{ github.ref_name }}${TAG_SUFFIX}"
            fi
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            # ä¸»åˆ†æ”¯
            TAGS="${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:latest${TAG_SUFFIX}"
            TAGS="${TAGS},${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:stable${TAG_SUFFIX}"
            # é˜¿é‡Œäº‘æ ‡ç­¾
            ALI_TAGS="${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:${{ env.GDAL_VERSION }}${TAG_SUFFIX}"
            ALI_TAGS="${ALI_TAGS},${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:latest${TAG_SUFFIX}"
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            # å¼€å‘åˆ†æ”¯
            TAGS="${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:dev${TAG_SUFFIX}"
            TAGS="${TAGS},${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:nightly${TAG_SUFFIX}"
            # é˜¿é‡Œäº‘æ ‡ç­¾
            ALI_TAGS="${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:${{ env.GDAL_VERSION }}-dev${TAG_SUFFIX}"
          else
            # å…¶ä»–åˆ†æ”¯æˆ–PR
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9.-]/-/g')
            TAGS="${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:${SAFE_BRANCH}${TAG_SUFFIX}"
            ALI_TAGS="${{ env.ALI_REGISTRY }}/${{ env.ALI_IMAGE_NAME }}:${SAFE_BRANCH}${TAG_SUFFIX}"
          fi
          
          # åˆå¹¶æ‰€æœ‰æ ‡ç­¾
          ALL_TAGS="$TAGS"
          if [[ -n "$ALI_TAGS" ]]; then
            ALL_TAGS="${ALL_TAGS},${ALI_TAGS}"
          fi
          
          # ç”Ÿæˆç¼“å­˜é”®
          CACHE_KEY="gdal-openjdk-${{ env.GDAL_VERSION }}-java${{ env.JAVA_VERSION }}-$(echo '$PLATFORMS' | tr ',' '-' | tr '/' '-')"
          
          # è¾“å‡ºé…ç½®
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "registry=${{ env.REGISTRY }}" >> $GITHUB_OUTPUT
          echo "image-name=$IMAGE_NAME_LOWER" >> $GITHUB_OUTPUT
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "push-enabled=$PUSH_ENABLED" >> $GITHUB_OUTPUT
          echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "tags=$ALL_TAGS" >> $GITHUB_OUTPUT
          echo "ali-tags=$ALI_TAGS" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºé…ç½®
          echo "ðŸ”§ Build Configuration:"
          echo "  ðŸ“¦ Registry: ${{ env.REGISTRY }}"
          echo "  ðŸ·ï¸  Image: $IMAGE_NAME_LOWER"
          echo "  ðŸ—ï¸  Platforms: $PLATFORMS"
          echo "  ðŸ“¤ Push: $PUSH_ENABLED"
          echo "  ðŸ”– GitHub Tags: $TAGS"
          echo "  ðŸ”– Aliyun Tags: $ALI_TAGS"
          echo "  ðŸ—‚ï¸  Cache Key: $CACHE_KEY"

  # æž„å»ºå’ŒæŽ¨é€é•œåƒ
  build-and-push:
    name: ðŸ—ï¸ Build and Push
    runs-on: ubuntu-latest
    needs: build-config
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Container Registry
        if: needs.build-config.outputs.push-enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.build-config.outputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Log in to Aliyun Container Registry
        if: needs.build-config.outputs.push-enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALI_REGISTRY }}
          username: ${{ secrets.ALI_REGISTRY_USERNAME }}
          password: ${{ secrets.ALI_REGISTRY_PASSWORD }}

      - name: ðŸ› ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
          platforms: ${{ needs.build-config.outputs.platforms }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.build-config.outputs.registry }}/${{ needs.build-config.outputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=GDAL OpenJDK
            org.opencontainers.image.description=Ubuntu-based GDAL ${{ env.GDAL_VERSION }} with OpenJDK ${{ env.JAVA_VERSION }}
            org.opencontainers.image.vendor=GDAL Project
            gdal.version=${{ env.GDAL_VERSION }}
            java.version=${{ env.JAVA_VERSION }}
            architecture=${{ needs.build-config.outputs.platforms }}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./gdal
          file: ./gdal/Dockerfile_openjdk
          platforms: ${{ needs.build-config.outputs.platforms }}
          push: ${{ needs.build-config.outputs.push-enabled }}
          tags: ${{ needs.build-config.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ needs.build-config.outputs.cache-key }}
          cache-to: type=gha,mode=max,scope=${{ needs.build-config.outputs.cache-key }}
          build-args: |
            GDAL_VERSION=${{ env.GDAL_VERSION }}
            BUILDKIT_INLINE_CACHE=1

      - name: ðŸ“‹ Image digest
        if: needs.build-config.outputs.push-enabled == 'true'
        run: |
          echo "ðŸŽ¯ Image digest: ${{ steps.meta.outputs.digest }}"
          echo "ðŸ·ï¸ Tags: ${{ needs.build-config.outputs.tags }}"

  # æµ‹è¯•æž„å»ºçš„é•œåƒ
  test-image:
    name: ðŸ§ª Test Image
    runs-on: ubuntu-latest
    needs: [build-config, build-and-push]
    if: needs.build-config.outputs.push-enabled == 'true'
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.build-config.outputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§ª Test image functionality
        run: |
          # èŽ·å–ç¬¬ä¸€ä¸ªæ ‡ç­¾è¿›è¡Œæµ‹è¯•
          FIRST_TAG=$(echo "${{ needs.build-config.outputs.tags }}" | cut -d',' -f1)
          echo "ðŸ·ï¸ Testing tag: $FIRST_TAG"
          
          # ä¸ºç‰¹å®šå¹³å°æ‹‰å–é•œåƒ
          PLATFORM="${{ matrix.platform }}"
          docker pull --platform=$PLATFORM $FIRST_TAG
          
          echo "ðŸ” Testing GDAL functionality..."
          docker run --rm --platform=$PLATFORM $FIRST_TAG gdalinfo --version
          
          echo "â˜• Testing Java functionality..."
          docker run --rm --platform=$PLATFORM $FIRST_TAG java -version
          
          echo "ðŸ” Testing GDAL Java bindings..."
          docker run --rm --platform=$PLATFORM $FIRST_TAG ls -la /usr/local/share/java/gdal.jar
          
          echo "âœ… Platform $PLATFORM tests passed!"

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build-config, build-and-push]
    if: needs.build-config.outputs.push-enabled == 'true'
    permissions:
      security-events: write
      
    steps:
      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-config.outputs.registry }}/${{ needs.build-config.outputs.image-name }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # æž„å»ºæ€»ç»“
  build-summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [build-config, build-and-push, test-image]
    if: always()
    
    steps:
      - name: ðŸ“‹ Create build summary
        run: |
          echo "## ðŸ³ GDAL OpenJDK Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ·ï¸ Image**: \`${{ needs.build-config.outputs.image-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ—ï¸ Platforms**: \`${{ needs.build-config.outputs.platforms }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¤ Push**: \`${{ needs.build-config.outputs.push-enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”– Tags**: \`${{ needs.build-config.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ GDAL Version**: \`${{ env.GDAL_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **â˜• Java Version**: \`${{ env.JAVA_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€
          if [[ "${{ needs.build-and-push.result }}" == "success" ]]; then
            echo "### âœ… Build Status: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æµ‹è¯•çŠ¶æ€
          if [[ "${{ needs.test-image.result }}" == "success" ]]; then
            echo "### âœ… Test Status: Passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-image.result }}" == "skipped" ]]; then
            echo "### â­ï¸ Test Status: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Test Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-config.outputs.push-enabled }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Usage" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
            FIRST_TAG=$(echo "${{ needs.build-config.outputs.tags }}" | cut -d',' -f1)
            echo "docker pull $FIRST_TAG" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
            echo "docker run -it --rm $FIRST_TAG" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi