name: ğŸ·ï¸ Release and Tag Management

on:
  # å‘å¸ƒåˆ›å»ºæ—¶è§¦å‘
  release:
    types: [published, edited]
    
  # æ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬ç®¡ç†
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gdal-multi-arch
  GDAL_VERSION: "3.7.1"

jobs:
  # ç‰ˆæœ¬ç®¡ç†
  version-management:
    name: ğŸ“‹ Version Management
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      
    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
      release-notes: ${{ steps.version.outputs.release-notes }}
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Get current version
        id: current-version
        run: |
          # ä»æœ€æ–°çš„tagè·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "v0.0.0")
          echo "current-version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Current version: ${CURRENT_VERSION}"

      - name: ğŸ”¢ Calculate new version
        id: version
        run: |
          CURRENT="${{ steps.current-version.outputs.current-version }}"
          TYPE="${{ inputs.version_type }}"
          
          # ç§»é™¤vå‰ç¼€è¿›è¡Œè®¡ç®—
          CURRENT_NUM=${CURRENT#v}
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_NUM"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          
          # æ ¹æ®ç±»å‹é€’å¢ç‰ˆæœ¬
          case $TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
            "prerelease")
              # é¢„å‘å¸ƒç‰ˆæœ¬æ·»åŠ -rcåç¼€
              PATCH=$((PATCH + 1))
              NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}-rc.$(date +%Y%m%d%H%M)"
              ;;
          esac
          
          if [[ "$TYPE" != "prerelease" ]]; then
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "new-version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ New version: ${NEW_VERSION}"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          RELEASE_NOTES=$(cat << EOF
          ## ğŸ³ GDAL Multi-Arch Docker Image ${NEW_VERSION}
          
          ### ğŸ“¦ é•œåƒä¿¡æ¯
          - **GDALç‰ˆæœ¬**: ${{ env.GDAL_VERSION }}
          - **Javaç‰ˆæœ¬**: Oracle JDK 8å…¼å®¹ (Zulu JDK)
          - **æ”¯æŒæ¶æ„**: linux/amd64, linux/arm64
          - **åŸºç¡€é•œåƒ**: Alpine Linux
          
          ### ğŸ·ï¸ é•œåƒæ ‡ç­¾
          \`\`\`bash
          # æœ€æ–°ç‰ˆæœ¬
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${NEW_VERSION#v}
          
          # æœ€æ–°ç¨³å®šç‰ˆ
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - âœ… Javaä¸“ç”¨GDALç»‘å®šï¼ˆä¸åŒ…å«Pythonï¼‰
          - âœ… å¤šæ¶æ„æ”¯æŒ (AMD64/ARM64)
          - âœ… è½»é‡åŒ–AlpineåŸºç¡€é•œåƒ
          - âœ… å®Œæ•´çš„åœ°ç†ç©ºé—´æ•°æ®å¤„ç†èƒ½åŠ›
          - âœ… ç”Ÿäº§å°±ç»ªçš„å®‰å…¨é…ç½®
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          \`\`\`bash
          # è¿è¡Œå®¹å™¨
          docker run -it --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${NEW_VERSION#v}
          
          # ä½¿ç”¨docker-compose
          docker-compose up -d
          \`\`\`
          
          ### ğŸ“ å®Œæ•´æ›´æ–°æ—¥å¿—
          æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´å†…å®¹ã€‚
          EOF
          )
          
          # ä¿å­˜å‘å¸ƒè¯´æ˜åˆ°æ–‡ä»¶
          echo "$RELEASE_NOTES" > release-notes.md
          echo "release-notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create and push tag
        run: |
          NEW_VERSION="${{ steps.version.outputs.new-version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"
          
          echo "âœ… Created and pushed tag: $NEW_VERSION"

      - name: ğŸ“¦ Create GitHub Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new-version }}
          name: GDAL Multi-Arch ${{ steps.version.outputs.new-version }}
          body_path: release-notes.md
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            gdal/Dockerfile
            gdal/docker-compose.yml
            gdal/README.md

  # å¤„ç†å‘å¸ƒäº‹ä»¶
  handle-release:
    name: ğŸš€ Handle Release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Extract release metadata
        id: meta
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          VERSION=${RELEASE_TAG#v}
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          
          # æ„å»ºæ ‡ç­¾åˆ—è¡¨
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          
          if [[ "$IS_PRERELEASE" == "false" ]]; then
            # ç¨³å®šç‰ˆæœ¬
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable"
            
            # æ·»åŠ ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬æ ‡ç­¾
            IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            
            if [[ -n "$MAJOR" && -n "$MINOR" ]]; then
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MAJOR}"
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MAJOR}.${MINOR}"
            fi
          else
            # é¢„å‘å¸ƒç‰ˆæœ¬
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prerelease"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is-prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Release tags: ${TAGS}"

      - name: ğŸ—ï¸ Build and push release image
        uses: docker/build-push-action@v5
        with:
          context: ./gdal
          file: ./gdal/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            org.opencontainers.image.title=GDAL Multi-Architecture
            org.opencontainers.image.description=Alpine-based GDAL ${{ env.GDAL_VERSION }} with Oracle JDK 8 for multi-architecture
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.url=${{ github.event.repository.html_url }}
            org.opencontainers.image.source=${{ github.event.repository.clone_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            gdal.version=${{ env.GDAL_VERSION }}
            java.version=8
            release.version=${{ steps.meta.outputs.version }}
            release.prerelease=${{ steps.meta.outputs.is-prerelease }}
          cache-from: type=gha,scope=release-gdal-${{ env.GDAL_VERSION }}
          cache-to: type=gha,mode=max,scope=release-gdal-${{ env.GDAL_VERSION }}

      - name: ğŸ“‹ Update release with image info
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          append_body: true
          body: |
            
            ## ğŸ³ Dockeré•œåƒå·²å‘å¸ƒ
            
            **é•œåƒæ ‡ç­¾**: 
            ```
            ${{ steps.meta.outputs.tags }}
            ```
            
            **æ‹‰å–å‘½ä»¤**:
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ```

  # æ¸…ç†æ—§çš„é¢„å‘å¸ƒç‰ˆæœ¬
  cleanup-prereleases:
    name: ğŸ§¹ Cleanup Old Prereleases
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.release.prerelease == false
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: ğŸ—‘ï¸ Delete old prerelease images
        run: |
          echo "ğŸ§¹ Cleaning up old prerelease images..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘ï¼Œæ¯”å¦‚åˆ é™¤æ—§çš„é¢„å‘å¸ƒé•œåƒ
          # æ³¨æ„ï¼šéœ€è¦é€‚å½“çš„æƒé™å’ŒAPIè°ƒç”¨
          echo "âœ… Cleanup completed"