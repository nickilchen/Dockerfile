# 基于OpenJDK 8u342的GDAL 3.7.1镜像
# 包含GEOS、PROJ、JPEG、HDF5、HDF4、NetCDF库并集成到Java
# 支持多架构部署（AMD64、ARM64）

# 使用buildx构建时，Docker会根据目标平台自动选择正确的基础镜像
FROM --platform=$TARGETPLATFORM openjdk:8u342-jdk

# 设置标签信息
LABEL maintainer="GDAL OpenJDK Image"
LABEL description="Ubuntu-based GDAL 3.7.1 image with OpenJDK 8u342 and full library support"
LABEL version="1.0.0"
LABEL gdal.version="3.7.1"
LABEL java.version="OpenJDK 8u342"
LABEL features="geos,proj,jpeg,hdf5,hdf4,netcdf,java-bindings"
LABEL architecture="amd64,arm64"

# 设置环境变量
ENV GDAL_VERSION=3.7.1
ENV GDAL_DATA=/usr/local/share/gdal
ENV JAVA_HOME=/usr/local/openjdk-8
ENV PATH=$PATH:$JAVA_HOME/bin
ENV CLASSPATH=/usr/local/share/java/gdal.jar
ENV LD_LIBRARY_PATH=/usr/local/share/java:$LD_LIBRARY_PATH

# 设置非交互式前端以避免提示
ENV DEBIAN_FRONTEND=noninteractive

# 创建非root用户
RUN groupadd -r -g 1000 gdaluser && \
    useradd -r -u 1000 -g gdaluser -m -d /home/gdaluser -s /bin/bash gdaluser

# 安装系统依赖和构建工具
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # 基础工具
        bash \
        curl \
        wget \
        ca-certificates \
        tar \
        gzip \
        xz-utils \
        # 构建工具
        build-essential \
        cmake \
        make \
        gcc \
        g++ \
        pkg-config \
        # GDAL编译依赖
        sqlite3 \
        libsqlite3-dev \
        libexpat1-dev \
        zlib1g-dev \
        libpng-dev \
        libtiff5-dev \
        libgeotiff-dev \
        libxml2-dev \
        # GEOS库
        libgeos-dev \
        # PROJ库
        libproj-dev \
        # JPEG库
        libjpeg-dev \
        # HDF5库
        libhdf5-dev \
        # HDF4库
        libhdf4-alt-dev \
        # NetCDF库
        libnetcdf-dev \
        # Java开发工具
        swig \
        # Apache Ant（构建Java绑定必需）
        ant \
    && rm -rf /var/lib/apt/lists/*

# 编译安装GDAL 3.7.1（启用所有需要的库和Java绑定）
RUN cd /tmp && \
    wget https://github.com/OSGeo/gdal/releases/download/v${GDAL_VERSION}/gdal-${GDAL_VERSION}.tar.gz && \
    tar -xzf gdal-${GDAL_VERSION}.tar.gz && \
    cd gdal-${GDAL_VERSION} && \
    mkdir build && \
    cd build && \
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DGDAL_USE_GEOS=ON \
        -DGDAL_USE_SQLITE3=ON \
        -DGDAL_USE_PROJ=ON \
        -DGDAL_USE_JPEG=ON \
        -DGDAL_USE_PNG=ON \
        -DGDAL_USE_TIFF=ON \
        -DGDAL_USE_GEOTIFF=ON \
        -DGDAL_USE_HDF5=ON \
        -DGDAL_USE_HDF4=ON \
        -DGDAL_USE_NETCDF=ON \
        -DBUILD_PYTHON_BINDINGS=OFF \
        -DBUILD_JAVA_BINDINGS=ON \
        -DJAVA_HOME=$JAVA_HOME \
        -DSWIG_EXECUTABLE=/usr/bin/swig && \
    make -j$(nproc) && \
    make install && \
    # 安装Java绑定
    mkdir -p /usr/local/share/java && \
    cp swig/java/gdal.jar /usr/local/share/java/ && \
    cp swig/java/*.so /usr/local/lib/ && \
    cp -rf swig/java/*.so $JAVA_HOME/jre/lib/ext/ && \
    cp -rf swig/java/gdal.jar $JAVA_HOME/jre/lib/ext/ && \
    ldconfig && \
    cd / && \
    rm -rf /tmp/gdal-${GDAL_VERSION}*

# 清理构建依赖（保留运行时依赖）
RUN apt-get remove -y \
        build-essential \
        cmake \
        make \
        gcc \
        g++ \
        swig \
        ant \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /tmp/*

# 验证GDAL安装
RUN gdalinfo --version && \
    echo "GDAL ${GDAL_VERSION} installation verified" && \
    # 验证GDAL版本
    gdal-config --version | grep -q "${GDAL_VERSION}" && \
    echo "GDAL version check passed" && \
    # 验证Java GDAL绑定
    ls -la /usr/local/share/java/gdal.jar && \
    echo "Java GDAL bindings installed"

# 验证Java安装
RUN java -version && \
    echo "OpenJDK 8u342 installation verified" && \
    # 验证Java版本
    java -version 2>&1 | grep -q "1.8.0_342" && \
    echo "Java version check passed" && \
    # 验证CLASSPATH设置
    echo "CLASSPATH: $CLASSPATH"

# 创建工作目录
RUN mkdir -p /data /workspace && \
    chown -R gdaluser:gdaluser /data /workspace

# 设置工作目录
WORKDIR /workspace

# 切换到非root用户
USER gdaluser

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD gdalinfo --version || exit 1

# 默认命令
CMD ["bash"]